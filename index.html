<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>TikTok Fetih SavaÅŸÄ±</title>
    <script src="/socket.io/socket.io.js"></script> <style>
        body { margin: 0; overflow: hidden; background: #111; color: white; font-family: 'Arial Black', sans-serif; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 5; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 2px solid #555; }
        .ulke {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
            z-index: 10;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
        }
        .secili { outline: 5px solid gold; z-index: 50 !important; transform: scale(1.1); }
        .isgal-toprak { position: absolute; z-index: 1; border: 1px solid rgba(0,0,0,0.2); }
        .log { position: fixed; bottom: 20px; right: 20px; width: 280px; height: 120px; background: rgba(0,0,0,0.8); overflow-y: auto; padding: 10px; font-size: 12px; border: 1px solid #444; }
        kbd { background: #555; padding: 2px 6px; border-radius: 4px; color: gold; }
    </style>
</head>
<body>

<canvas id="savas-canvas"></canvas>
<div id="ui">
    <h2 style="margin:0; color: gold;">FETÄ°H SAVAÅI</h2>
    <p><kbd>Ãœ</kbd> Ãœlke Kur | <kbd>S</kbd> SavaÅŸ | <kbd>D</kbd> Destek</p>
    <div id="durum">Bir Ã¼lke seÃ§in...</div>
</div>
<div id="log" class="log">YayÄ±n bekleniyor...</div>
<div id="harita"></div>

<script>
    const harita = document.getElementById('harita');
    const log = document.getElementById('log');
    const canvas = document.getElementById('savas-canvas');
    const ctx = canvas.getContext('2d');
    
    let ulkeler = [];
    let seciliUlke = null;
    let savasDevamEdiyor = false;

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    function mesaj(m) {
        const d = document.createElement('div');
        d.innerHTML = `<span style="color:gray">${new Date().toLocaleTimeString()}</span>: ${m}`;
        log.prepend(d);
    }

    function ulkeKur(isim = "") {
        const ad = isim || prompt("Ãœlke AdÄ±:");
        if(!ad) return;

        const boyut = 80 + Math.random() * 60;
        const x = Math.random() * (window.innerWidth - 150);
        const y = Math.random() * (window.innerHeight - 150);
        const renk = `hsl(${Math.random() * 360}, 75%, 50%)`;

        const yeni = {
            id: Date.now(),
            ad: ad,
            asker: 100,
            renk: renk,
            x: x, y: y,
            boyut: boyut,
            div: null
        };

        ulkeler.push(yeni);
        cizUlke(yeni);
        mesaj(`<b style="color:${renk}">${ad}</b> kuruldu!`);
    }

    function cizUlke(u) {
        const div = document.createElement('div');
        div.className = 'ulke';
        div.style.width = u.boyut + 'px';
        div.style.height = u.boyut + 'px';
        div.style.left = u.x + 'px';
        div.style.top = u.y + 'px';
        div.style.backgroundColor = u.renk;
        div.style.borderRadius = "50%"; // Ana merkezler hala yuvarlak

        div.onclick = (e) => {
            e.stopPropagation();
            if(seciliUlke) seciliUlke.div.classList.remove('secili');
            seciliUlke = u;
            div.classList.add('secili');
            document.getElementById('durum').innerText = `SeÃ§ili: ${u.ad} (âš”ï¸ ${Math.floor(u.asker)})`;
        };

        u.div = div;
        harita.appendChild(div);
        guncelleMetin(u);
    }

    function guncelleMetin(u) {
        u.div.innerHTML = `<div>${u.ad.substring(0,10)}<br><b>${Math.floor(u.asker)}</b></div>`;
    }

    function savas() {
        if(!seciliUlke || savasDevamEdiyor) return;
        const rakipler = ulkeler.filter(u => u.id !== seciliUlke.id);
        if(rakipler.length === 0) return;

        const rakip = rakipler[Math.floor(Math.random() * rakipler.length)];
        olumuneSavas(seciliUlke, rakip);
    }

    function olumuneSavas(saldÄ±ran, savunan) {
        savasDevamEdiyor = true;
        mesaj(`âš”ï¸ <b>${saldÄ±ran.ad}</b> vs <b>${savunan.ad}</b> baÅŸladÄ±!`);

        const dongu = setInterval(() => {
            // Asker KaybÄ± MantÄ±ÄŸÄ±
            const saldiriGucu = Math.random() * 4;
            const savunmaGucu = Math.random() * 3;

            savunan.asker -= saldiriGucu;
            saldÄ±ran.asker -= savunmaGucu;

            // GÃ¶rsel Asker AkÄ±ÅŸÄ±
            cizAskerEfekt(saldÄ±ran, savunan);
            guncelleMetin(saldÄ±ran);
            guncelleMetin(savunan);

            // Biri biterse dur
            if(savunan.asker <= 0 || saldÄ±ran.asker <= 0) {
                clearInterval(dongu);
                ctx.clearRect(0,0, canvas.width, canvas.height);
                savasDevamEdiyor = false;
                
                if(savunan.asker <= 0) fethet(saldÄ±ran, savunan);
                else yokOl(saldÄ±ran, savunan);
            }
        }, 50);
    }

    function fethet(kazanan, kaybeden) {
        mesaj(`ğŸ† <b>${kazanan.ad}</b> kazandÄ± ve <b>${kaybeden.ad}</b> topraklarÄ±nÄ± ele geÃ§irdi!`);
        
        // Kaybeden Ã¼lkenin yerine kare toprak koy
        const kare = document.createElement('div');
        kare.className = 'isgal-toprak';
        kare.style.width = kaybeden.boyut + 'px';
        kare.style.height = kaybeden.boyut + 'px';
        kare.style.left = kaybeden.x + 'px';
        kare.style.top = kaybeden.y + 'px';
        kare.style.backgroundColor = kazanan.renk;
        kare.style.opacity = "0.7";
        harita.appendChild(kare);

        // Kaybedeni sil
        kaybeden.div.remove();
        ulkeler = ulkeler.filter(u => u.id !== kaybeden.id);
        kazanan.asker += 40; // Fetih Ã¶dÃ¼lÃ¼
    }

    function yokOl(kaybeden, kazanan) {
        mesaj(`ğŸ’€ <b>${kaybeden.ad}</b> saldÄ±rÄ±rken yok oldu!`);
        kaybeden.div.remove();
        ulkeler = ulkeler.filter(u => u.id !== kaybeden.id);
        seciliUlke = null;
    }

    function cizAskerEfekt(k, h) {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.strokeStyle = k.renk;
        ctx.setLineDash([5, 5]);
        ctx.moveTo(k.x + k.boyut/2, k.y + k.boyut/2);
        ctx.lineTo(h.x + h.boyut/2, h.y + h.boyut/2);
        ctx.stroke();

        // Mermiler
        ctx.fillStyle = "white";
        for(let i=0; i<3; i++) {
            let t = (Date.now() % 1000) / 1000;
            let px = (k.x + k.boyut/2) * (1-t) + (h.x + h.boyut/2) * t;
            let py = (k.y + k.boyut/2) * (1-t) + (h.y + h.boyut/2) * t;
            ctx.fillRect(px, py, 5, 5);
        }
    }

    function destek() {
        if(!seciliUlke) return;
        seciliUlke.asker += 50;
        mesaj(`ğŸ“¦ ${seciliUlke.ad} asker takviyesi aldÄ±!`);
        guncelleMetin(seciliUlke);
    }

    window.onkeydown = (e) => {
        const k = e.key.toLowerCase();
        if(k === 'Ã¼') ulkeKur();
        if(k === 's') savas();
        if(k === 'd') destek();
    };

    // Node.js BaÄŸlantÄ±sÄ± iÃ§in (EÄŸer app.js kullanÄ±yorsan)
    if(typeof socket !== 'undefined') {
        socket.on('yeniUlke', (data) => {
            ulkeKur(data.isim);
        });
    }
</script>
</body>
</html>
